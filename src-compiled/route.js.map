{"version":3,"sources":["../src/route.js"],"names":["$methods","$uri","$handler","$name","$prefix","$bindings","$wheres","$compiled","trim","string","charAt","substr","length","prefix","$this","get","compileRoute","regexp","uri","keys","required","optional","replace","_","val","push","compiled","set","Route","constructor","methods","handler","options","i","hasOwnProperty","name","value","wheres","bindings","path","matches","request","indexOf","method","RegExp","exec","resolve","params","values","key","parse","prefixed","Error","handle","call","apply"],"mappings":"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","file":"route.js","sourcesContent":["\"use strict\";\n\nvar $methods = new WeakMap(),\n    $uri = new WeakMap(),\n    $handler = new WeakMap(),\n    $name = new WeakMap(),\n    $prefix = new WeakMap(),\n    $bindings = new WeakMap(),\n    $wheres = new WeakMap(),\n    $compiled = new WeakMap();\n\nfunction trim(string) {\n    if (string.charAt(0) == \"/\") {\n        string = string.substr(1, string.length - 1);\n    }\n\n    if (string.charAt(string.length - 1) == \"/\") {\n        string = string.substr(0, string.length - 1);\n    }\n\n    return string;\n}\n\nfunction prefix($this) {\n    return $prefix.get($this) !== null ? \"/\" + $prefix.get($this) : \"\";\n}\n\nfunction compileRoute($this) {\n    var regexp = $this.uri,\n        keys = [],\n        required = [],\n        optional = [];\n\n    regexp = regexp.replace(/(?:{(\\w+)\\?})/g, function (_, val) {\n        keys.push(val);\n        optional.push(val);\n\n        if (typeof $wheres.get($this)[val] !== \"undefined\") {\n            return \"(\" + $wheres.get($this)[val] + \")?\";\n        }\n\n        return \"(\\\\w+)?\";\n    });\n\n    regexp = regexp.replace(/(?:{(\\w+)})/g, function (_, val) {\n        keys.push(val);\n        required.push(val);\n\n        if (typeof $wheres.get($this)[val] !== \"undefined\") {\n            return \"(\" + $wheres.get($this)[val] + \")\";\n        }\n\n        return \"(\\\\w+)\";\n    });\n\n    var compiled = {\n        regexp: regexp,\n        keys: keys,\n        required: required,\n        optional: optional\n    };\n\n    $compiled.set($this, compiled);\n\n    return compiled;\n}\n\nclass Route {\n    constructor(methods, uri, handler, options = {}) {\n        $methods.set(this, methods);\n        $uri.set(this, trim(uri));\n        $handler.set(this, handler);\n        $name.set(this, null);\n        $prefix.set(this, null);\n        $bindings.set(this, {});\n        $wheres.set(this, {});\n        $compiled.set(this, null);\n\n        for (var i in options) {\n            if (options.hasOwnProperty(i)) {\n                if (i == \"where\") {\n                    $wheres.set(this, options[i]);\n                }\n\n                if (i == \"name\") {\n                    $name.set(this, options[i]);\n                }\n\n                if (i == \"prefix\") {\n                    $prefix.set(this, trim(options[i]));\n                }\n            }\n        }\n    }\n\n    get methods() {\n        return $methods.get(this);\n    }\n\n    get uri() {\n        return $uri.get(this);\n    }\n\n    get handler() {\n        return $handler.get(this);\n    }\n\n    get name() {\n        return $name.get(this);\n    }\n\n    set name(value) {\n        $name.set(this, value);\n    }\n\n    get prefix() {\n        return $prefix.get(this);\n    }\n\n    set prefix(value) {\n        $prefix.set(this, trim(value));\n    }\n\n    get wheres() {\n        return $wheres.get(this);\n    }\n\n    get bindings() {\n        return $bindings.get(this);\n    }\n\n    get compiled() {\n        return $compiled.get(this);\n    }\n\n    get path() {\n        return prefix(this) + \"/\" + $uri.get(this);\n    }\n\n    matches(request) {\n        var compiled = compileRoute(this),\n            regexp = prefix(this) + \"/\" + compiled.regexp;\n\n        if ($methods.get(this).indexOf(request.method) < 0) {\n            return false;\n        }\n\n        if ((new RegExp(`^${regexp}$`)).exec(request.path) === null) {\n            return false;\n        }\n\n        return true;\n    }\n\n    resolve(request) {\n        var params = {},\n            compiled = $compiled.get(this);\n\n        if (compiled === null) {\n            compiled = compileRoute(this);\n        }\n\n        var regexp = prefix(this) + \"/\" + compiled.regexp,\n            keys = compiled.keys,\n            values = [];\n\n        request.path.replace(new RegExp(`^${regexp}$`), function (_, val) {\n            values.push(val);\n        });\n\n        for (let key in keys) {\n            params[keys[key]] = values[key];\n        }\n\n        return params;\n    }\n\n    parse(params = {}, prefixed = true) {\n        var path = $uri.get(this);\n\n        path = path.replace(/(?:{(\\w+)\\?})/g, function (_, val) {\n            if (typeof params[val] !== \"undefined\") {\n                return params[val];\n            }\n\n            return \"\";\n        });\n\n        path = path.replace(/(?:{(\\w+)})/g, function (_, val) {\n            if (typeof params[val] !== \"undefined\") {\n                return params[val];\n            }\n\n            throw new Error(`Required route param \"${val}\" is missing.`);\n        });\n\n        return prefixed === true ? prefix(this) + \"/\" + path : path;\n    }\n\n    async handle() {\n        var handler = await($handler.get(this)).call();\n\n        // Bindings values to handler right before the calling\n        for (let i in $bindings.get(this)) {\n            if ($bindings.get(this).hasOwnProperty(i)) {\n                handler[i] = $bindings.get(this)[i];\n            }\n        }\n\n        return await handler.apply(handler, Array.from(arguments));\n    }\n}\n\nexport default Route;"]}