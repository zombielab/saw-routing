{"version":3,"sources":["../src/route.js"],"names":["$methods","$uri","$handler","$name","$prefix","$bindings","$wheres","$defaults","$compiled","$secure","prefix","$this","get","compileRoute","regexp","keys","required","optional","replace","_","val","push","compiled","set","Route","constructor","methods","uri","handler","options","i","hasOwnProperty","name","value","wheres","defaults","bindings","path","secure","matches","request","indexOf","method","RegExp","exec","resolve","params","values","key","handle","call","apply"],"mappings":"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","file":"route.js","sourcesContent":["\"use strict\";\n\nimport {trim} from \"saw-support/lib/helpers\";\n\nvar $methods = new WeakMap(),\n    $uri = new WeakMap(),\n    $handler = new WeakMap(),\n    $name = new WeakMap(),\n    $prefix = new WeakMap(),\n    $bindings = new WeakMap(),\n    $wheres = new WeakMap(),\n    $defaults = new WeakMap(),\n    $compiled = new WeakMap(),\n    $secure = new WeakMap();\n\nfunction prefix($this) {\n    return $prefix.get($this) !== null ? \"/\" + $prefix.get($this) : \"\";\n}\n\nfunction compileRoute($this) {\n    var regexp = $uri.get($this),\n        keys = [],\n        required = [],\n        optional = [];\n\n    regexp = regexp.replace(/(?:{(.*?)\\?})/g, function (_, val) {\n        keys.push(val);\n        optional.push(val);\n\n        if (typeof $wheres.get($this)[val] !== \"undefined\") {\n            return \"(\" + $wheres.get($this)[val] + \")?\";\n        }\n\n        return \"(.*?)?\";\n    });\n\n    regexp = regexp.replace(/(?:{(.*?)})/g, function (_, val) {\n        keys.push(val);\n        required.push(val);\n\n        if (typeof $wheres.get($this)[val] !== \"undefined\") {\n            return \"(\" + $wheres.get($this)[val] + \")\";\n        }\n\n        return \"(.*?)\";\n    });\n\n    var compiled = {\n        regexp: regexp,\n        keys: keys,\n        required: required,\n        optional: optional\n    };\n\n    $compiled.set($this, compiled);\n\n    return compiled;\n}\n\nclass Route {\n    constructor(methods, uri, handler, options = {}) {\n        $methods.set(this, methods);\n        $uri.set(this, trim(uri, \"/\"));\n        $handler.set(this, handler);\n        $name.set(this, null);\n        $prefix.set(this, null);\n        $bindings.set(this, {});\n        $wheres.set(this, {});\n        $defaults.set(this, {});\n        $compiled.set(this, null);\n        $secure.set(this, null);\n\n        for (var i in options) {\n            if (options.hasOwnProperty(i)) {\n                if (i == \"where\") {\n                    $wheres.set(this, options[i]);\n                }\n\n                if (i == \"default\") {\n                    $defaults.set(this, options[i]);\n                }\n\n                if (i == \"name\") {\n                    $name.set(this, options[i]);\n                }\n\n                if (i == \"prefix\") {\n                    $prefix.set(this, trim(options[i], \"/\"));\n                }\n\n                if (i == \"secure\") {\n                    $secure.set(this, options[i]);\n                }\n            }\n        }\n    }\n\n    get methods() {\n        return $methods.get(this);\n    }\n\n    get uri() {\n        return $uri.get(this);\n    }\n\n    get handler() {\n        return $handler.get(this);\n    }\n\n    get name() {\n        return $name.get(this);\n    }\n\n    set name(value) {\n        $name.set(this, value);\n    }\n\n    get prefix() {\n        return $prefix.get(this);\n    }\n\n    set prefix(value) {\n        $prefix.set(this, trim(value, \"/\"));\n    }\n\n    get wheres() {\n        return $wheres.get(this);\n    }\n\n    get defaults() {\n        return $defaults.get(this);\n    }\n\n    get bindings() {\n        return $bindings.get(this);\n    }\n\n    get compiled() {\n        return $compiled.get(this);\n    }\n\n    get path() {\n        return prefix(this) + \"/\" + $uri.get(this);\n    }\n\n    get secure() {\n        return $secure.get(this);\n    }\n\n    set secure(value) {\n        $secure.set(this, value);\n    }\n\n    matches(request) {\n        var compiled = compileRoute(this),\n            regexp = prefix(this) + \"/\" + compiled.regexp;\n\n        if ($methods.get(this).indexOf(request.method) < 0) {\n            return false;\n        }\n\n        if ((new RegExp(`^${regexp}$`)).exec(request.path) === null) {\n            return false;\n        }\n\n        return true;\n    }\n\n    resolve(request) {\n        var params = $defaults.get(this),\n            compiled = compileRoute(this);\n\n        var regexp = prefix(this) + \"/\" + compiled.regexp,\n            keys = compiled.keys,\n            values = [];\n\n        request.path.replace(new RegExp(`^${regexp}$`), function (_, val) {\n            values.push(val);\n        });\n\n        for (let key in keys) {\n            if (typeof values[key] !== \"undefined\") {\n                params[keys[key]] = values[key];\n            }\n        }\n\n        return params;\n    }\n\n    async handle() {\n        var handler = await($handler.get(this)).call();\n\n        // Bindings values to handler right before the calling\n        for (let i in $bindings.get(this)) {\n            if ($bindings.get(this).hasOwnProperty(i)) {\n                handler[i] = $bindings.get(this)[i];\n            }\n        }\n\n        return await handler.apply(handler, Array.from(arguments));\n    }\n}\n\nexport default Route;"]}