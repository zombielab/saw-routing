{"version":3,"sources":["../src/route.js"],"names":["$methods","$uri","$handler","$name","$prefix","$bindings","$wheres","$defaults","$compiled","trim","string","charAt","substr","length","prefix","$this","get","compileRoute","regexp","keys","required","optional","replace","_","val","push","compiled","set","Route","constructor","methods","uri","handler","options","i","hasOwnProperty","name","value","wheres","defaults","bindings","path","matches","request","indexOf","method","RegExp","exec","resolve","params","values","key","parse","prefixed","Error","handle","call","apply"],"mappings":"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","file":"route.js","sourcesContent":["\"use strict\";\n\nvar $methods = new WeakMap(),\n    $uri = new WeakMap(),\n    $handler = new WeakMap(),\n    $name = new WeakMap(),\n    $prefix = new WeakMap(),\n    $bindings = new WeakMap(),\n    $wheres = new WeakMap(),\n    $defaults = new WeakMap(),\n    $compiled = new WeakMap();\n\nfunction trim(string) {\n    if (string.charAt(0) == \"/\") {\n        string = string.substr(1, string.length - 1);\n    }\n\n    if (string.charAt(string.length - 1) == \"/\") {\n        string = string.substr(0, string.length - 1);\n    }\n\n    return string;\n}\n\nfunction prefix($this) {\n    return $prefix.get($this) !== null ? \"/\" + $prefix.get($this) : \"\";\n}\n\nfunction compileRoute($this) {\n    var regexp = $uri.get($this),\n        keys = [],\n        required = [],\n        optional = [];\n\n    regexp = regexp.replace(/(?:{(\\w+)\\?})/g, function (_, val) {\n        keys.push(val);\n        optional.push(val);\n\n        if (typeof $wheres.get($this)[val] !== \"undefined\") {\n            return \"(\" + $wheres.get($this)[val] + \")?\";\n        }\n\n        return \"(\\\\w+)?\";\n    });\n\n    regexp = regexp.replace(/(?:{(\\w+)})/g, function (_, val) {\n        keys.push(val);\n        required.push(val);\n\n        if (typeof $wheres.get($this)[val] !== \"undefined\") {\n            return \"(\" + $wheres.get($this)[val] + \")\";\n        }\n\n        return \"(\\\\w+)\";\n    });\n\n    var compiled = {\n        regexp: regexp,\n        keys: keys,\n        required: required,\n        optional: optional\n    };\n\n    $compiled.set($this, compiled);\n\n    return compiled;\n}\n\nclass Route {\n    constructor(methods, uri, handler, options = {}) {\n        $methods.set(this, methods);\n        $uri.set(this, trim(uri));\n        $handler.set(this, handler);\n        $name.set(this, null);\n        $prefix.set(this, null);\n        $bindings.set(this, {});\n        $wheres.set(this, {});\n        $defaults.set(this, {});\n        $compiled.set(this, null);\n\n        for (var i in options) {\n            if (options.hasOwnProperty(i)) {\n                if (i == \"where\") {\n                    $wheres.set(this, options[i]);\n                }\n\n                if (i == \"default\") {\n                    $defaults.set(this, options[i]);\n                }\n\n                if (i == \"name\") {\n                    $name.set(this, options[i]);\n                }\n\n                if (i == \"prefix\") {\n                    $prefix.set(this, trim(options[i]));\n                }\n            }\n        }\n    }\n\n    get methods() {\n        return $methods.get(this);\n    }\n\n    get uri() {\n        return $uri.get(this);\n    }\n\n    get handler() {\n        return $handler.get(this);\n    }\n\n    get name() {\n        return $name.get(this);\n    }\n\n    set name(value) {\n        $name.set(this, value);\n    }\n\n    get prefix() {\n        return $prefix.get(this);\n    }\n\n    set prefix(value) {\n        $prefix.set(this, trim(value));\n    }\n\n    get wheres() {\n        return $wheres.get(this);\n    }\n\n    get defaults() {\n        return $defaults.get(this);\n    }\n\n    get bindings() {\n        return $bindings.get(this);\n    }\n\n    get compiled() {\n        return $compiled.get(this);\n    }\n\n    get path() {\n        return prefix(this) + \"/\" + $uri.get(this);\n    }\n\n    matches(request) {\n        var compiled = compileRoute(this),\n            regexp = prefix(this) + \"/\" + compiled.regexp;\n\n        if ($methods.get(this).indexOf(request.method) < 0) {\n            return false;\n        }\n\n        if ((new RegExp(`^${regexp}$`)).exec(request.path) === null) {\n            return false;\n        }\n\n        return true;\n    }\n\n    resolve(request) {\n        var params = $defaults.get(this),\n            compiled = compileRoute(this);\n\n        var regexp = prefix(this) + \"/\" + compiled.regexp,\n            keys = compiled.keys,\n            values = [];\n\n        request.path.replace(new RegExp(`^${regexp}$`), function (_, val) {\n            values.push(val);\n        });\n\n        for (let key in keys) {\n            if (typeof values[key] !== \"undefined\") {\n                params[keys[key]] = values[key];\n            }\n        }\n\n        return params;\n    }\n\n    parse(params = {}, prefixed = true) {\n        var path = $uri.get(this);\n\n        path = path.replace(/(?:{(\\w+)\\?})/g, function (_, val) {\n            if (typeof params[val] !== \"undefined\") {\n                return params[val];\n            }\n\n            return \"\";\n        });\n\n        path = path.replace(/(?:{(\\w+)})/g, function (_, val) {\n            if (typeof params[val] !== \"undefined\") {\n                return params[val];\n            }\n\n            throw new Error(`Required route param \"${val}\" is missing.`);\n        });\n\n        return prefixed === true ? prefix(this) + \"/\" + path : path;\n    }\n\n    async handle() {\n        var handler = await($handler.get(this)).call();\n\n        // Bindings values to handler right before the calling\n        for (let i in $bindings.get(this)) {\n            if ($bindings.get(this).hasOwnProperty(i)) {\n                handler[i] = $bindings.get(this)[i];\n            }\n        }\n\n        return await handler.apply(handler, Array.from(arguments));\n    }\n}\n\nexport default Route;"]}